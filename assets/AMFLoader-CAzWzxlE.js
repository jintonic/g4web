import"./three-module-BI8WDeO_.js";import{u as O}from"./three-editor-CgUf__d2.js";import{a4 as D,a6 as V,G as S,b5 as B,F as R,o as I,u as H,c as z}from"./three-core-BBimCphi.js";class _ extends D{constructor(u){super(u)}load(u,p,x,f){const s=this,d=new V(s.manager);d.setPath(s.path),d.setResponseType("arraybuffer"),d.setRequestHeader(s.requestHeader),d.setWithCredentials(s.withCredentials),d.load(u,function(E){try{p(s.parse(E))}catch(b){f?f(b):console.error(b),s.manager.itemError(u)}},x,f)}parse(u){function p(a){let t=new DataView(a);if(String.fromCharCode(t.getUint8(0),t.getUint8(1))==="PK"){let l=null,r=null;console.log("THREE.AMFLoader: Loading Zip");try{l=O(new Uint8Array(a))}catch(i){if(i instanceof ReferenceError)return console.log("THREE.AMFLoader: fflate missing and file is compressed."),null}for(r in l)if(r.toLowerCase().slice(-4)===".amf")break;console.log("THREE.AMFLoader: Trying to load file asset: "+r),t=new DataView(l[r].buffer)}const n=new TextDecoder().decode(t),e=new DOMParser().parseFromString(n,"application/xml");return e.documentElement.nodeName.toLowerCase()!=="amf"?(console.log("THREE.AMFLoader: Error loading AMF - no AMF document found."),null):e}function x(a){let t=1,o="millimeter";a.documentElement.attributes.unit!==void 0&&(o=a.documentElement.attributes.unit.value.toLowerCase());const n={millimeter:1,inch:25.4,feet:304.8,meter:1e3,micron:.001};return n[o]!==void 0&&(t=n[o]),console.log("THREE.AMFLoader: Unit scale: "+t),t}function f(a){let t="AMF Material";const o=a.attributes.id.textContent;let n={r:1,g:1,b:1,a:1},e=null;for(let l=0;l<a.childNodes.length;l++){const r=a.childNodes[l];r.nodeName==="metadata"&&r.attributes.type!==void 0?r.attributes.type.value==="name"&&(t=r.textContent):r.nodeName==="color"&&(n=s(r))}return e=new B({flatShading:!0,color:new I(n.r,n.g,n.b),name:t}),n.a!==1&&(e.transparent=!0,e.opacity=n.a),{id:o,material:e}}function s(a){const t={r:1,g:1,b:1,a:1};for(let o=0;o<a.childNodes.length;o++){const n=a.childNodes[o];n.nodeName==="r"?t.r=n.textContent:n.nodeName==="g"?t.g=n.textContent:n.nodeName==="b"?t.b=n.textContent:n.nodeName==="a"&&(t.a=n.textContent)}return t}function d(a){const t={name:"",triangles:[],materialId:null};let o=a.firstElementChild;for(a.attributes.materialid!==void 0&&(t.materialId=a.attributes.materialid.nodeValue);o;){if(o.nodeName==="metadata")o.attributes.type!==void 0&&o.attributes.type.value==="name"&&(t.name=o.textContent);else if(o.nodeName==="triangle"){const n=o.getElementsByTagName("v1")[0].textContent,e=o.getElementsByTagName("v2")[0].textContent,l=o.getElementsByTagName("v3")[0].textContent;t.triangles.push(n,e,l)}o=o.nextElementSibling}return t}function E(a){const t=[],o=[];let n=a.firstElementChild;for(;n;){if(n.nodeName==="vertex"){let e=n.firstElementChild;for(;e;){if(e.nodeName==="coordinates"){const l=e.getElementsByTagName("x")[0].textContent,r=e.getElementsByTagName("y")[0].textContent,i=e.getElementsByTagName("z")[0].textContent;t.push(l,r,i)}else if(e.nodeName==="normal"){const l=e.getElementsByTagName("nx")[0].textContent,r=e.getElementsByTagName("ny")[0].textContent,i=e.getElementsByTagName("nz")[0].textContent;o.push(l,r,i)}e=e.nextElementSibling}}n=n.nextElementSibling}return{vertices:t,normals:o}}function b(a){const t=a.attributes.id.textContent,o={name:"amfobject",meshes:[]};let n=null,e=a.firstElementChild;for(;e;){if(e.nodeName==="metadata")e.attributes.type!==void 0&&e.attributes.type.value==="name"&&(o.name=e.textContent);else if(e.nodeName==="color")n=s(e);else if(e.nodeName==="mesh"){let l=e.firstElementChild;const r={vertices:[],normals:[],volumes:[],color:n};for(;l;){if(l.nodeName==="vertices"){const i=E(l);r.normals=r.normals.concat(i.normals),r.vertices=r.vertices.concat(i.vertices)}else l.nodeName==="volume"&&r.volumes.push(d(l));l=l.nextElementSibling}o.meshes.push(r)}e=e.nextElementSibling}return{id:t,obj:o}}const w=p(u);let M="",A="";const C=x(w),y={},v={},T=w.documentElement.childNodes;let c,N;for(c=0;c<T.length;c++){const a=T[c];if(a.nodeName==="metadata")a.attributes.type!==void 0&&(a.attributes.type.value==="name"?M=a.textContent:a.attributes.type.value==="author"&&(A=a.textContent));else if(a.nodeName==="material"){const t=f(a);y[t.id]=t.material}else if(a.nodeName==="object"){const t=b(a);v[t.id]=t.obj}}const g=new S,F=new B({name:D.DEFAULT_MATERIAL_NAME,color:11184895,flatShading:!0});g.name=M,g.userData.author=A,g.userData.loader="AMF";for(const a in v){const t=v[a],o=t.meshes,n=new S;for(n.name=t.name||"",c=0;c<o.length;c++){let e=F;const l=o[c],r=new R(l.vertices,3);let i=null;if(l.normals.length&&(i=new R(l.normals,3)),l.color){const m=l.color;e=F.clone(),e.color=new I(m.r,m.g,m.b),m.a!==1&&(e.transparent=!0,e.opacity=m.a)}const j=l.volumes;for(N=0;N<j.length;N++){const m=j[N],h=new H;let L=e;h.setIndex(m.triangles),h.setAttribute("position",r.clone()),i&&h.setAttribute("normal",i.clone()),y[m.materialId]!==void 0&&(L=y[m.materialId]),h.scale(C,C,C),n.add(new z(h,L.clone()))}}g.add(n)}return g}}export{_ as AMFLoader};
