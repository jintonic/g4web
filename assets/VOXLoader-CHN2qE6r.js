import"./three-module-JdtKHQRM.js";import{a4 as tf,a6 as ef,i as cf,G as D,o as nf,Z as xf,u as sf,F as K,M as of,c as rf}from"./three-core-CfGtZoax.js";function Q(r,e){const t=r.getUint32(e,!0);e+=4;let o="";for(let c=0;c<t;c++)o+=String.fromCharCode(r.getUint8(e++));return{value:o,size:4+t}}function M(r,e){const t={},o=r.getUint32(e,!0);e+=4;let c=4;for(let s=0;s<o;s++){const f=Q(r,e);e+=f.size,c+=f.size;const x=Q(r,e);e+=x.size,c+=x.size,t[f.value]=x.value}return{value:t,size:c}}function af(r){const e=r&3,t=r>>2&3,o=r>>4&1?-1:1,c=r>>5&1?-1:1,s=r>>6&1?-1:1,f=3-e-t,x=[[0,0,0],[0,0,0],[0,0,0]];x[0][e]=o,x[1][t]=c,x[2][f]=s;const a=new cf;return a.set(x[0][0],x[0][2],-x[0][1],0,x[2][0],x[2][2],-x[2][1],0,-x[1][0],-x[1][2],x[1][1],0,0,0,0,1),a}function W(r,e){if(e.attributes._name&&(r.name=e.attributes._name),e.frames.length>0){const t=e.frames[0];t.rotation&&r.applyMatrix4(t.rotation),t.translation&&r.position.set(t.translation.x,t.translation.z,-t.translation.y)}}function H(r,e,t){const o=e[r];if(o.type==="transform"){const c=e[o.childNodeId],s=o.frames[0],f=s&&(s.rotation||s.translation);if(c.type==="shape"&&c.models.length===1){const m=t[c.models[0].modelId],R=F(m);return W(R,o),R}if(!f){const m=H(o.childNodeId,e,t);return m&&o.attributes._name&&(m.name=o.attributes._name),m}const x=new D;W(x,o);const a=H(o.childNodeId,e,t);return a&&x.add(a),x}else if(o.type==="group"){const c=new D;for(const s of o.childIds){const f=H(s,e,t);f&&c.add(f)}return c}else if(o.type==="shape"){if(o.models.length===1){const s=t[o.models[0].modelId];return F(s)}const c=new D;for(const s of o.models){const f=t[s.modelId];c.add(F(f))}return c}return null}class uf extends tf{load(e,t,o,c){const s=this,f=new ef(s.manager);f.setPath(s.path),f.setResponseType("arraybuffer"),f.setRequestHeader(s.requestHeader),f.load(e,function(x){try{t(s.parse(x))}catch(a){c?c(a):console.error(a),s.manager.itemError(e)}},o,c)}parse(e){const t=new DataView(e),o=t.getUint32(0,!0),c=t.getUint32(4,!0);if(o!==542658390){console.error("THREE.VOXLoader: Invalid VOX file.");return}if(c!==150&&c!==200){console.error("THREE.VOXLoader: Invalid VOX file. Unsupported version:",c);return}const s=[0,4294967295,4291624959,4288282623,4284940287,4281597951,4278255615,4294954239,4291611903,4288269567,4284927231,4281584895,4278242559,4294941183,4291598847,4288256511,4284914175,4281571839,4278229503,4294928127,4291585791,4288243455,4284901119,4281558783,4278216447,4294915071,4291572735,4288230399,4284888063,4281545727,4278203391,4294902015,4291559679,4288217343,4284875007,4281532671,4278190335,4294967244,4291624908,4288282572,4284940236,4281597900,4278255564,4294954188,4291611852,4288269516,4284927180,4281584844,4278242508,4294941132,4291598796,4288256460,4284914124,4281571788,4278229452,4294928076,4291585740,4288243404,4284901068,4281558732,4278216396,4294915020,4291572684,4288230348,4284888012,4281545676,4278203340,4294901964,4291559628,4288217292,4284874956,4281532620,4278190284,4294967193,4291624857,4288282521,4284940185,4281597849,4278255513,4294954137,4291611801,4288269465,4284927129,4281584793,4278242457,4294941081,4291598745,4288256409,4284914073,4281571737,4278229401,4294928025,4291585689,4288243353,4284901017,4281558681,4278216345,4294914969,4291572633,4288230297,4284887961,4281545625,4278203289,4294901913,4291559577,4288217241,4284874905,4281532569,4278190233,4294967142,4291624806,4288282470,4284940134,4281597798,4278255462,4294954086,4291611750,4288269414,4284927078,4281584742,4278242406,4294941030,4291598694,4288256358,4284914022,4281571686,4278229350,4294927974,4291585638,4288243302,4284900966,4281558630,4278216294,4294914918,4291572582,4288230246,4284887910,4281545574,4278203238,4294901862,4291559526,4288217190,4284874854,4281532518,4278190182,4294967091,4291624755,4288282419,4284940083,4281597747,4278255411,4294954035,4291611699,4288269363,4284927027,4281584691,4278242355,4294940979,4291598643,4288256307,4284913971,4281571635,4278229299,4294927923,4291585587,4288243251,4284900915,4281558579,4278216243,4294914867,4291572531,4288230195,4284887859,4281545523,4278203187,4294901811,4291559475,4288217139,4284874803,4281532467,4278190131,4294967040,4291624704,4288282368,4284940032,4281597696,4278255360,4294953984,4291611648,4288269312,4284926976,4281584640,4278242304,4294940928,4291598592,4288256256,4284913920,4281571584,4278229248,4294927872,4291585536,4288243200,4284900864,4281558528,4278216192,4294914816,4291572480,4288230144,4284887808,4281545472,4278203136,4294901760,4291559424,4288217088,4284874752,4281532416,4278190318,4278190301,4278190267,4278190250,4278190216,4278190199,4278190165,4278190148,4278190114,4278190097,4278251008,4278246656,4278237952,4278233600,4278224896,4278220544,4278211840,4278207488,4278198784,4278194432,4293787648,4292673536,4290445312,4289331200,4287102976,4285988864,4283760640,4282646528,4280418304,4279304192,4293848814,4292730333,4290493371,4289374890,4287137928,4286019447,4283782485,4282664004,4280427042,4279308561];let f=8,x;const a=[],m={};let R=s;for(;f<t.byteLength;){let i="";for(let n=0;n<4;n++)i+=String.fromCharCode(t.getUint8(f++));const y=t.getUint32(f,!0);if(f+=4,f+=4,i==="SIZE"){const n=t.getUint32(f,!0);f+=4;const l=t.getUint32(f,!0);f+=4;const p=t.getUint32(f,!0);f+=4,x={palette:s,size:{x:n,y:l,z:p}},a.push(x),f+=y-12}else if(i==="XYZI"){const n=t.getUint32(f,!0);f+=4,x.data=new Uint8Array(e,f,n*4),f+=n*4}else if(i==="RGBA"){R=[0];for(let n=0;n<256;n++)R[n+1]=t.getUint32(f,!0),f+=4;x.palette=R}else if(i==="nTRN"){const n=t.getUint32(f,!0);f+=4;const l=M(t,f);f+=l.size;const p=t.getUint32(f,!0);f+=4,f+=4;const v=t.getInt32(f,!0);f+=4;const h=t.getUint32(f,!0);f+=4;const S=[];for(let k=0;k<h;k++){const b=M(t,f);f+=b.size;const A={rotation:null,translation:null};if(b.value._r!==void 0&&(A.rotation=af(parseInt(b.value._r))),b.value._t!==void 0){const g=b.value._t.split(" ").map(Number);A.translation={x:g[0],y:g[1],z:g[2]}}S.push(A)}m[n]={type:"transform",id:n,attributes:l.value,childNodeId:p,layerId:v,frames:S}}else if(i==="nGRP"){const n=t.getUint32(f,!0);f+=4;const l=M(t,f);f+=l.size;const p=t.getUint32(f,!0);f+=4;const v=[];for(let h=0;h<p;h++)v.push(t.getUint32(f,!0)),f+=4;m[n]={type:"group",id:n,attributes:l.value,childIds:v}}else if(i==="nSHP"){const n=t.getUint32(f,!0);f+=4;const l=M(t,f);f+=l.size;const p=t.getUint32(f,!0);f+=4;const v=[];for(let h=0;h<p;h++){const S=t.getUint32(f,!0);f+=4;const k=M(t,f);f+=k.size,v.push({modelId:S,attributes:k.value})}m[n]={type:"shape",id:n,attributes:l.value,models:v}}else f+=y}for(let i=0;i<a.length;i++)a[i].palette=R;let u=null;Object.keys(m).length>0&&(u=H(0,m,a));const N={chunks:a,scene:u};let T=!1;return new Proxy(N,{get(i,y){return typeof y=="string"&&/^\d+$/.test(y)?(T||(console.warn("THREE.VOXLoader: Accessing result as an array is deprecated. Use result.chunks[] instead."),T=!0),i.chunks[parseInt(y)]):y==="length"?(T||(console.warn("THREE.VOXLoader: Accessing result as an array is deprecated. Use result.chunks instead."),T=!0),i.chunks.length):y===Symbol.iterator?(T||(console.warn("THREE.VOXLoader: Iterating result as an array is deprecated. Use result.chunks instead."),T=!0),i.chunks[Symbol.iterator].bind(i.chunks)):i[y]}})}}function F(r){const e=r.data,t=r.size,o=r.palette,c=t.x,s=t.y,f=t.z,x=new Uint8Array(c*s*f);for(let n=0;n<e.length;n+=4){const l=e[n+0],p=e[n+1],v=e[n+2],h=e[n+3];x[l+p*c+v*c*s]=h}const a=[],m=[],R=[],u=new nf;let N=!1;const T=[c,s,f];for(let n=0;n<3;n++){const l=(n+1)%3,p=(n+2)%3,v=T[n],h=T[l],S=T[p],k=[0,0,0],b=new Int16Array(h*S);k[n]=1;for(let A=0;A<=v;A++){let g=0;for(let L=0;L<S;L++)for(let V=0;V<h;V++){const I=[0,0,0];I[n]=A,I[l]=V,I[p]=L;const w=I[0],O=I[1],C=I[2],d=A>0?x[w-k[0]+(O-k[1])*c+(C-k[2])*c*s]:0,z=A<v?x[w+O*c+C*c*s]:0;d>0&&z===0?b[g]=d:z>0&&d===0?b[g]=-z:b[g]=0,g++}g=0;for(let L=0;L<S;L++)for(let V=0;V<h;){const I=b[g];if(I!==0){let w=1;for(;V+w<h&&b[g+w]===I;)w++;let O=1,C=!1;for(;L+O<S&&!C;){for(let E=0;E<w;E++)if(b[g+E+O*h]!==I){C=!0;break}C||O++}const d=[0,0,0];d[n]=A,d[l]=V,d[p]=L;const z=[0,0,0],_=[0,0,0];z[l]=w,_[p]=O;const ff=Math.abs(I),G=o[ff],P=(G>>0&255)/255,j=(G>>8&255)/255,q=(G>>16&255)/255;(P>0||j>0||q>0)&&(N=!0),u.setRGB(P,j,q,xf);const X=E=>[E[0]-c/2,E[2]-f/2,-E[1]+s/2],Z=X(d),Y=X([d[0]+z[0],d[1]+z[1],d[2]+z[2]]),$=X([d[0]+z[0]+_[0],d[1]+z[1]+_[1],d[2]+z[2]+_[2]]),J=X([d[0]+_[0],d[1]+_[1],d[2]+_[2]]),U=a.length/3;I>0?(a.push(...Z,...Y,...$,...J),m.push(U,U+1,U+2,U,U+2,U+3)):(a.push(...Z,...J,...$,...Y),m.push(U,U+1,U+2,U,U+2,U+3)),R.push(u.r,u.g,u.b,u.r,u.g,u.b,u.r,u.g,u.b,u.r,u.g,u.b);for(let E=0;E<O;E++)for(let B=0;B<w;B++)b[g+B+E*h]=0;V+=w,g+=w}else V++,g++}}}const i=new sf;i.setAttribute("position",new K(a,3)),i.setIndex(m),i.computeVertexNormals();const y=new of;return N&&(i.setAttribute("color",new K(R,3)),y.vertexColors=!0),new rf(i,y)}export{uf as VOXLoader,F as buildMesh};
