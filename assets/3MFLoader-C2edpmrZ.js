import{a4 as X,a6 as Te,ae as De,G,o as Re,Z as je,i as ke,u as E,a3 as K,aW as I,c as P,F as T,al as q,an as V,am as Z,$ as L,L as J,ak as Q,M as Ee}from"./vendor-three-cPJTOjbb.js";import{u as Ie}from"./vendor-editor-SgCfGT6Z.js";import"./vendor-libs-B2226kbd.js";const U=je;class Oe extends X{constructor(w){super(w),this.availableExtensions=[]}load(w,D,C,S){const v=this,M=new Te(v.manager);M.setPath(v.path),M.setResponseType("arraybuffer"),M.setRequestHeader(v.requestHeader),M.setWithCredentials(v.withCredentials),M.load(w,function(O){try{D(v.parse(O))}catch(R){S?S(R):console.error(R),v.manager.itemError(w)}},C,S)}parse(w){const D=this,C=new De(this.manager);function S(t){let e=null,r=null,n,o;const s=[],l=[];let a;const i={},u={},p={},c=new TextDecoder;try{e=Ie(new Uint8Array(t))}catch(f){if(f instanceof ReferenceError)return console.error("THREE.3MFLoader: fflate missing and file is compressed."),null}let x=null;for(r in e)r.match(/\_rels\/.rels$/)?n=r:r.match(/3D\/_rels\/.*\.model\.rels$/)?o=r:r.match(/^3D\/[^\/]*\.model$/)?x=r:r.match(/^3D\/.*\/.*\.model$/)?s.push(r):r.match(/^3D\/Textures?\/.*/)&&l.push(r);if(s.push(x),n===void 0)throw new Error("THREE.ThreeMFLoader: Cannot find relationship file `rels` in 3MF archive.");const m=e[n],h=c.decode(m),b=v(h);if(o){const f=e[o],d=c.decode(f);a=v(d)}for(let f=0;f<s.length;f++){const d=s[f],g=e[d],y=c.decode(g),k=new DOMParser().parseFromString(y,"application/xml");k.documentElement.nodeName.toLowerCase()!=="model"&&console.error("THREE.3MFLoader: Error loading 3MF - no 3MF document found: ",d);const F=k.querySelector("model"),N={};for(let B=0;B<F.attributes.length;B++){const W=F.attributes[B];W.name.match(/^xmlns:(.+)$/)&&(N[W.value]=RegExp.$1)}const A=ue(F);A.xml=F,0<Object.keys(N).length&&(A.extensions=N),i[d]=A}for(let f=0;f<l.length;f++){const d=l[f];p[d]=e[d].buffer}return{rels:b,modelRels:a,model:i,printTicket:u,texture:p}}function v(t){const e=[],n=new DOMParser().parseFromString(t,"application/xml").querySelectorAll("Relationship");for(let o=0;o<n.length;o++){const s=n[o],l={target:s.getAttribute("Target"),id:s.getAttribute("Id"),type:s.getAttribute("Type")};e.push(l)}return e}function M(t){const e={};for(let r=0;r<t.length;r++){const n=t[r],o=n.getAttribute("name");0<=["Title","Designer","Description","Copyright","LicenseTerms","Rating","CreationDate","ModificationDate"].indexOf(o)&&(e[o]=n.textContent)}return e}function O(t){const e={id:t.getAttribute("id"),basematerials:[]},r=t.querySelectorAll("base");for(let n=0;n<r.length;n++){const o=r[n],s=re(o);s.index=n,e.basematerials.push(s)}return e}function R(t){return{id:t.getAttribute("id"),path:t.getAttribute("path"),contenttype:t.getAttribute("contenttype"),tilestyleu:t.getAttribute("tilestyleu"),tilestylev:t.getAttribute("tilestylev"),filter:t.getAttribute("filter")}}function Y(t){const e={id:t.getAttribute("id"),texid:t.getAttribute("texid"),displaypropertiesid:t.getAttribute("displaypropertiesid")},r=t.querySelectorAll("tex2coord"),n=[];for(let o=0;o<r.length;o++){const s=r[o],l=s.getAttribute("u"),a=s.getAttribute("v");n.push(parseFloat(l),parseFloat(a))}return e.uvs=new Float32Array(n),e}function ee(t){const e={id:t.getAttribute("id"),displaypropertiesid:t.getAttribute("displaypropertiesid")},r=t.querySelectorAll("color"),n=[],o=new Re;for(let s=0;s<r.length;s++){const a=r[s].getAttribute("color");o.setStyle(a.substring(0,7),U),n.push(o.r,o.g,o.b)}return e.colors=new Float32Array(n),e}function H(t){const e=t.children,r={};for(let n=0;n<e.length;n++){const o={type:e[n].nodeName.substring(2)};for(let s=0;s<e[n].attributes.length;s++){const l=e[n].attributes[s];l.specified&&(o[l.name]=l.value)}r[e[n].getAttribute("identifier")]=o}return r}function te(t){const e={id:t.getAttribute("id"),displayname:t.getAttribute("displayname")},r=t.children,n={};for(let o=0;o<r.length;o++){const s=r[o];if(s.nodeName==="i:in"||s.nodeName==="i:out")n[s.nodeName==="i:in"?"inputs":"outputs"]=H(s);else{const l=s.children,a={op:s.nodeName.substring(2),identifier:s.getAttribute("identifier")};for(let i=0;i<l.length;i++)a[l[i].nodeName.substring(2)]=H(l[i]);n[a.identifier]=a}}return e.operations=n,e}function se(t){const e={id:t.getAttribute("id")},r=t.querySelectorAll("pbmetallic"),n=[];for(let o=0;o<r.length;o++){const s=r[o];n.push({name:s.getAttribute("name"),metallicness:parseFloat(s.getAttribute("metallicness")),roughness:parseFloat(s.getAttribute("roughness"))})}return e.data=n,e}function re(t){const e={};return e.name=t.getAttribute("name"),e.displaycolor=t.getAttribute("displaycolor"),e.displaypropertiesid=t.getAttribute("displaypropertiesid"),e}function ne(t){const e={},r=[],n=t.querySelectorAll("vertices vertex");for(let a=0;a<n.length;a++){const i=n[a],u=i.getAttribute("x"),p=i.getAttribute("y"),c=i.getAttribute("z");r.push(parseFloat(u),parseFloat(p),parseFloat(c))}e.vertices=new Float32Array(r);const o=[],s=[],l=t.querySelectorAll("triangles triangle");for(let a=0;a<l.length;a++){const i=l[a],u=i.getAttribute("v1"),p=i.getAttribute("v2"),c=i.getAttribute("v3"),x=i.getAttribute("p1"),m=i.getAttribute("p2"),h=i.getAttribute("p3"),b=i.getAttribute("pid"),f={};f.v1=parseInt(u,10),f.v2=parseInt(p,10),f.v3=parseInt(c,10),s.push(f.v1,f.v2,f.v3),x&&(f.p1=parseInt(x,10)),m&&(f.p2=parseInt(m,10)),h&&(f.p3=parseInt(h,10)),b&&(f.pid=b),0<Object.keys(f).length&&o.push(f)}return e.triangleProperties=o,e.triangles=new Uint32Array(s),e}function oe(t){const e=[],r=t.querySelectorAll("component");for(let n=0;n<r.length;n++){const o=r[n],s=ie(o);e.push(s)}return e}function ie(t){const e={};e.objectId=t.getAttribute("objectid");const r=t.getAttribute("transform");return r&&(e.transform=$(r)),e}function $(t){const e=[];t.split(" ").forEach(function(n){e.push(parseFloat(n))});const r=new ke;return r.set(e[0],e[3],e[6],e[9],e[1],e[4],e[7],e[10],e[2],e[5],e[8],e[11],0,0,0,1),r}function le(t){const e={type:t.getAttribute("type")},r=t.getAttribute("id");r&&(e.id=r);const n=t.getAttribute("pid");n&&(e.pid=n);const o=t.getAttribute("pindex");o&&(e.pindex=o);const s=t.getAttribute("thumbnail");s&&(e.thumbnail=s);const l=t.getAttribute("partnumber");l&&(e.partnumber=l);const a=t.getAttribute("name");a&&(e.name=a);const i=t.querySelector("mesh");i&&(e.mesh=ne(i));const u=t.querySelector("components");return u&&(e.components=oe(u)),e}function ae(t){const e={};e.basematerials={};const r=t.querySelectorAll("basematerials");for(let u=0;u<r.length;u++){const p=r[u],c=O(p);e.basematerials[c.id]=c}e.texture2d={};const n=t.querySelectorAll("texture2d");for(let u=0;u<n.length;u++){const p=n[u],c=R(p);e.texture2d[c.id]=c}e.colorgroup={};const o=t.querySelectorAll("colorgroup");for(let u=0;u<o.length;u++){const p=o[u],c=ee(p);e.colorgroup[c.id]=c}const s=t.querySelectorAll("implicitfunction");s.length>0&&(e.implicitfunction={});for(let u=0;u<s.length;u++){const p=s[u],c=te(p);e.implicitfunction[c.id]=c}e.pbmetallicdisplayproperties={};const l=t.querySelectorAll("pbmetallicdisplayproperties");for(let u=0;u<l.length;u++){const p=l[u],c=se(p);e.pbmetallicdisplayproperties[c.id]=c}e.texture2dgroup={};const a=t.querySelectorAll("texture2dgroup");for(let u=0;u<a.length;u++){const p=a[u],c=Y(p);e.texture2dgroup[c.id]=c}e.object={};const i=t.querySelectorAll("object");for(let u=0;u<i.length;u++){const p=i[u],c=le(p);e.object[c.id]=c}return e}function ce(t){const e=[],r=t.querySelectorAll("item");for(let n=0;n<r.length;n++){const o=r[n],s={objectId:o.getAttribute("objectid")},l=o.getAttribute("transform");l&&(s.transform=$(l)),e.push(s)}return e}function ue(t){const e={unit:t.getAttribute("unit")||"millimeter"},r=t.querySelectorAll("metadata");r&&(e.metadata=M(r));const n=t.querySelector("resources");n&&(e.resources=ae(n));const o=t.querySelector("build");return o&&(e.build=ce(o)),e}function pe(t,e,r,n){const o=t.texid,l=r.resources.texture2d[o];if(l){const a=n[l.path],i=l.contenttype,u=new Blob([a],{type:i}),p=URL.createObjectURL(u),c=C.load(p,function(){URL.revokeObjectURL(p)});switch(c.colorSpace=U,l.tilestyleu){case"wrap":c.wrapS=q;break;case"mirror":c.wrapS=Z;break;case"none":case"clamp":c.wrapS=V;break;default:c.wrapS=q}switch(l.tilestylev){case"wrap":c.wrapT=q;break;case"mirror":c.wrapT=Z;break;case"none":case"clamp":c.wrapT=V;break;default:c.wrapT=q}switch(l.filter){case"auto":c.magFilter=L,c.minFilter=J;break;case"linear":c.magFilter=L,c.minFilter=L,c.generateMipmaps=!1;break;case"nearest":c.magFilter=Q,c.minFilter=Q,c.generateMipmaps=!1;break;default:c.magFilter=L,c.minFilter=J}return c}else return null}function de(t,e,r,n,o,s,l){const a=l.pindex,i={};for(let c=0,x=e.length;c<x;c++){const m=e[c],h=m.p1!==void 0?m.p1:a;i[h]===void 0&&(i[h]=[]),i[h].push(m)}const u=Object.keys(i),p=[];for(let c=0,x=u.length;c<x;c++){const m=u[c],h=i[m],b=t.basematerials[m],f=j(b,n,o,s,l,ve),d=new E,g=[],y=r.vertices;for(let F=0,N=h.length;F<N;F++){const A=h[F];g.push(y[A.v1*3+0]),g.push(y[A.v1*3+1]),g.push(y[A.v1*3+2]),g.push(y[A.v2*3+0]),g.push(y[A.v2*3+1]),g.push(y[A.v2*3+2]),g.push(y[A.v3*3+0]),g.push(y[A.v3*3+1]),g.push(y[A.v3*3+2])}d.setAttribute("position",new T(g,3));const k=new P(d,f);p.push(k)}return p}function fe(t,e,r,n,o,s,l){const a=new E,i=[],u=[],p=r.vertices,c=t.uvs;for(let b=0,f=e.length;b<f;b++){const d=e[b];i.push(p[d.v1*3+0]),i.push(p[d.v1*3+1]),i.push(p[d.v1*3+2]),i.push(p[d.v2*3+0]),i.push(p[d.v2*3+1]),i.push(p[d.v2*3+2]),i.push(p[d.v3*3+0]),i.push(p[d.v3*3+1]),i.push(p[d.v3*3+2]),u.push(c[d.p1*2+0]),u.push(c[d.p1*2+1]),u.push(c[d.p2*2+0]),u.push(c[d.p2*2+1]),u.push(c[d.p3*2+0]),u.push(c[d.p3*2+1])}a.setAttribute("position",new T(i,3)),a.setAttribute("uv",new T(u,2));const x=j(t,n,o,s,l,pe),m=new I({map:x,flatShading:!0});return new P(a,m)}function me(t,e,r,n){const o=new E,s=[],l=[],a=r.vertices,i=t.colors;for(let c=0,x=e.length;c<x;c++){const m=e[c],h=m.v1,b=m.v2,f=m.v3;s.push(a[h*3+0]),s.push(a[h*3+1]),s.push(a[h*3+2]),s.push(a[b*3+0]),s.push(a[b*3+1]),s.push(a[b*3+2]),s.push(a[f*3+0]),s.push(a[f*3+1]),s.push(a[f*3+2]);const d=m.p1!==void 0?m.p1:n.pindex,g=m.p2!==void 0?m.p2:d,y=m.p3!==void 0?m.p3:d;l.push(i[d*3+0]),l.push(i[d*3+1]),l.push(i[d*3+2]),l.push(i[g*3+0]),l.push(i[g*3+1]),l.push(i[g*3+2]),l.push(i[y*3+0]),l.push(i[y*3+1]),l.push(i[y*3+2])}o.setAttribute("position",new T(s,3)),o.setAttribute("color",new T(l,3));const u=new I({vertexColors:!0,flatShading:!0});return new P(o,u)}function he(t){const e=new E;e.setIndex(new K(t.triangles,1)),e.setAttribute("position",new K(t.vertices,3));const r=new I({name:X.DEFAULT_MATERIAL_NAME,color:16777215,flatShading:!0});return new P(e,r)}function ge(t,e,r,n,o,s){const l=Object.keys(t),a=[];for(let i=0,u=l.length;i<u;i++){const p=l[i],c=t[p];switch(be(p,n)){case"material":const m=n.resources.basematerials[p],h=de(m,c,e,r,n,o,s);for(let d=0,g=h.length;d<g;d++)a.push(h[d]);break;case"texture":const b=n.resources.texture2dgroup[p];a.push(fe(b,c,e,r,n,o,s));break;case"vertexColors":const f=n.resources.colorgroup[p];a.push(me(f,c,e,s));break;case"default":a.push(he(e));break;default:console.error("THREE.3MFLoader: Unsupported resource type.")}}if(s.name)for(let i=0;i<a.length;i++)a[i].name=s.name;return a}function be(t,e){return e.resources.texture2dgroup[t]!==void 0?"texture":e.resources.basematerials[t]!==void 0?"material":e.resources.colorgroup[t]!==void 0?"vertexColors":t==="default"?"default":void 0}function ye(t,e){const r={},n=t.triangleProperties,o=e.pid;for(let s=0,l=n.length;s<l;s++){const a=n[s];let i=a.pid!==void 0?a.pid:o;i===void 0&&(i="default"),r[i]===void 0&&(r[i]=[]),r[i].push(a)}return r}function xe(t,e,r,n,o){const s=new G,l=ye(t,o),a=ge(l,t,e,r,n,o);for(let i=0,u=a.length;i<u;i++)s.add(a[i]);return s}function Ae(t,e,r){if(!t)return;const n=[],o=Object.keys(t);for(let s=0;s<o.length;s++){const l=o[s];for(let a=0;a<D.availableExtensions.length;a++){const i=D.availableExtensions[a];i.ns===l&&n.push(i)}}for(let s=0;s<n.length;s++){const l=n[s];l.apply(r,t[l.ns],e)}}function j(t,e,r,n,o,s){return t.build!==void 0||(t.build=s(t,e,r,n,o)),t.build}function ve(t,e,r){let n;const o=t.displaypropertiesid,s=r.resources.pbmetallicdisplayproperties;if(o!==null&&s[o]!==void 0){const u=s[o].data[t.index];n=new Ee({flatShading:!0,roughness:u.roughness,metalness:u.metallicness})}else n=new I({flatShading:!0});n.name=t.name;const l=t.displaycolor,a=l.substring(0,7);return n.color.setStyle(a,U),l.length===9&&(n.opacity=parseInt(l.charAt(7)+l.charAt(8),16)/255),n}function we(t,e,r,n){const o=new G;for(let s=0;s<t.length;s++){const l=t[s];let a=e[l.objectId];a===void 0&&(_(l.objectId,e,r,n),a=e[l.objectId]);const i=a.clone(),u=l.transform;u&&i.applyMatrix4(u),o.add(i)}return o}function _(t,e,r,n){const o=r.resources.object[t];if(o.mesh){const s=o.mesh,l=r.extensions,a=r.xml;Ae(l,s,a),e[o.id]=j(s,e,r,n,o,xe)}else{const s=o.components;e[o.id]=j(s,e,r,n,o,we)}o.name&&(e[o.id].name=o.name),r.resources.implicitfunction&&console.warn("THREE.ThreeMFLoader: Implicit Functions are implemented in data-only.",r.resources.implicitfunction)}function Fe(t){const e=t.model,r=t.modelRels,n={},o=Object.keys(e),s={};if(r)for(let l=0,a=r.length;l<a;l++){const i=r[l],u=i.target.substring(1);t.texture[u]&&(s[i.target]=t.texture[u])}for(let l=0;l<o.length;l++){const a=o[l],i=e[a],u=Object.keys(i.resources.object);for(let p=0;p<u.length;p++){const c=u[p];_(c,n,i,s)}}return n}function Me(t){for(let e=0;e<t.length;e++){const r=t[e];if(r.target.split(".").pop().toLowerCase()==="model")return r}}function Se(t,e){const r=new G,n=Me(e.rels),o=e.model[n.target.substring(1)].build;for(let s=0;s<o.length;s++){const l=o[s],a=t[l.objectId].clone(),i=l.transform;i&&a.applyMatrix4(i),r.add(a)}return r}const z=S(w),Ne=Fe(z);return Se(Ne,z)}addExtension(w){this.availableExtensions.push(w)}}export{Oe as ThreeMFLoader};
