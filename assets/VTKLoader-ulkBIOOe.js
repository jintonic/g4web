import"./three-module-Bzb5U4JC.js";import{a as W}from"./three-editor-DX7abzjo.js";import{a4 as J,a6 as K,o as X,u as M,F as z,Z as H,a3 as k}from"./three-core-S_L7YPKV.js";class et extends J{constructor(E){super(E)}load(E,V,Y,_){const U=this,j=new K(U.manager);j.setPath(U.path),j.setResponseType("arraybuffer"),j.setRequestHeader(U.requestHeader),j.setWithCredentials(U.withCredentials),j.load(E,function(B){try{V(U.parse(B))}catch(G){_?_(G):console.error(G),U.manager.itemError(E)}},Y,_)}parse(E){function V(T){const O=[],g=[],I=[],N=[];let D;const C=/^[^\d.\s-]+/;function L(S){const f=[],a=S.split(/\s+/);for(let i=0;i<a.length;i++)a[i]!==""&&f.push(parseFloat(a[i]));return f}const b=/^(\d+)\s+([\s\d]*)/,y=/^POINTS /,e=/^POLYGONS /,l=/^TRIANGLE_STRIPS /,r=/^POINT_DATA[ ]+(\d+)/,n=/^CELL_DATA[ ]+(\d+)/,t=/^COLOR_SCALARS[ ]+(\w+)[ ]+3/,o=/^NORMALS[ ]+(\w+)[ ]+(\w+)/;let s=!1,p=!1,u=!1,c=!1,h=!1,A=!1,x=!1;const m=new X,P=T.split(`
`);for(const S in P){const f=P[S].trim();if(f.indexOf("DATASET")===0){const a=f.split(" ")[1];if(a!=="POLYDATA")throw new Error("Unsupported DATASET type: "+a)}else if(s){if(C.exec(f)===null){const a=L(f);for(let i=0;i+2<a.length;i+=3)g.push(a[i],a[i+1],a[i+2])}}else if(p){if((D=b.exec(f))!==null){const a=parseInt(D[1]),i=D[2].split(/\s+/);if(a>=3){const w=parseInt(i[0]);let F=1;for(let R=0;R<a-2;++R){const v=parseInt(i[F]),q=parseInt(i[F+1]);O.push(w,v,q),F++}}}}else if(u){if((D=b.exec(f))!==null){const a=parseInt(D[1]),i=D[2].split(/\s+/);if(a>=3)for(let w=0;w<a-2;w++)if(w%2===1){const F=parseInt(i[w]),R=parseInt(i[w+2]),v=parseInt(i[w+1]);O.push(F,R,v)}else{const F=parseInt(i[w]),R=parseInt(i[w+1]),v=parseInt(i[w+2]);O.push(F,R,v)}}}else if(c||h){if(A){if(C.exec(f)===null){const a=L(f);for(let i=0;i+2<a.length;i+=3)m.setRGB(a[i],a[i+1],a[i+2],H),I.push(m.r,m.g,m.b)}}else if(x&&C.exec(f)===null){const a=L(f);for(let i=0;i+2<a.length;i+=3)N.push(a[i],a[i+1],a[i+2])}}e.exec(f)!==null?(p=!0,s=!1,u=!1):y.exec(f)!==null?(p=!1,s=!0,u=!1):l.exec(f)!==null?(p=!1,s=!1,u=!0):r.exec(f)!==null?(c=!0,s=!1,p=!1,u=!1):n.exec(f)!==null?(h=!0,s=!1,p=!1,u=!1):t.exec(f)!==null?(A=!0,x=!1,s=!1,p=!1,u=!1):o.exec(f)!==null&&(x=!0,A=!1,s=!1,p=!1,u=!1)}let d=new M;if(d.setIndex(O),d.setAttribute("position",new z(g,3)),N.length===g.length&&d.setAttribute("normal",new z(N,3)),I.length!==O.length)I.length===g.length&&d.setAttribute("color",new z(I,3));else{d=d.toNonIndexed();const S=d.attributes.position.count/3;if(I.length===S*3){const f=[];for(let a=0;a<S;a++){const i=I[3*a+0],w=I[3*a+1],F=I[3*a+2];m.setRGB(i,w,F,H),f.push(m.r,m.g,m.b),f.push(m.r,m.g,m.b),f.push(m.r,m.g,m.b)}d.setAttribute("color",new z(f,3))}}return d}function Y(T){const O=new Uint8Array(T),g=new DataView(T);let I=[],N=[],D=[],C=0;function L(l,r){let n=r,t=l[n];const o=[];for(;t!==10&&n<l.length;)o.push(String.fromCharCode(t)),n++,t=l[n];return{start:r,end:n,next:n+1,parsedString:o.join("")}}let b,y;for(;;){if(b=L(O,C),y=b.parsedString,y.indexOf("DATASET")===0){const l=y.split(" ")[1];if(l!=="POLYDATA")throw new Error("Unsupported DATASET type: "+l)}else if(y.indexOf("POINTS")===0){const l=parseInt(y.split(" ")[1],10),r=l*4*3;I=new Float32Array(l*3);let n=b.next;for(let t=0;t<l;t++)I[3*t]=g.getFloat32(n,!1),I[3*t+1]=g.getFloat32(n+4,!1),I[3*t+2]=g.getFloat32(n+8,!1),n=n+12;b.next=b.next+r+1}else if(y.indexOf("TRIANGLE_STRIPS")===0){const l=parseInt(y.split(" ")[1],10),r=parseInt(y.split(" ")[2],10),n=r*4;D=new Uint32Array(3*r-9*l);let t=0,o=b.next;for(let s=0;s<l;s++){const p=g.getInt32(o,!1),u=[];o+=4;for(let c=0;c<p;c++)u.push(g.getInt32(o,!1)),o+=4;for(let c=0;c<p-2;c++)c%2?(D[t++]=u[c],D[t++]=u[c+2],D[t++]=u[c+1]):(D[t++]=u[c],D[t++]=u[c+1],D[t++]=u[c+2])}b.next=b.next+n+1}else if(y.indexOf("POLYGONS")===0){const l=parseInt(y.split(" ")[1],10),r=parseInt(y.split(" ")[2],10),n=r*4;D=new Uint32Array(3*r-9*l);let t=0,o=b.next;for(let s=0;s<l;s++){const p=g.getInt32(o,!1),u=[];o+=4;for(let c=0;c<p;c++)u.push(g.getInt32(o,!1)),o+=4;for(let c=1;c<p-1;c++)D[t++]=u[0],D[t++]=u[c],D[t++]=u[c+1]}b.next=b.next+n+1}else if(y.indexOf("POINT_DATA")===0){const l=parseInt(y.split(" ")[1],10);b=L(O,b.next);const r=l*4*3;N=new Float32Array(l*3);let n=b.next;for(let t=0;t<l;t++)N[3*t]=g.getFloat32(n,!1),N[3*t+1]=g.getFloat32(n+4,!1),N[3*t+2]=g.getFloat32(n+8,!1),n+=12;b.next=b.next+r}if(C=b.next,C>=O.byteLength)break}const e=new M;return e.setIndex(new k(D,1)),e.setAttribute("position",new k(I,3)),N.length===I.length&&e.setAttribute("normal",new k(N,3)),e}function _(T,O){const g=T.length,I=new Float32Array(g+O.length);return I.set(T),I.set(O,g),I}function U(T,O){const g=T.length,I=new Int32Array(g+O.length);return I.set(T),I.set(O,g),I}function j(T){function O(e){let l={};if(e.nodeType===1){if(e.attributes&&e.attributes.length>0){l.attributes={};for(let r=0;r<e.attributes.length;r++){const n=e.attributes.item(r);l.attributes[n.nodeName]=n.nodeValue.trim()}}}else e.nodeType===3&&(l=e.nodeValue.trim());if(e.hasChildNodes())for(let r=0;r<e.childNodes.length;r++){const n=e.childNodes.item(r),t=n.nodeName;if(typeof l[t]>"u"){const o=O(n);o!==""&&(Array.isArray(o["#text"])&&(o["#text"]=o["#text"][0]),l[t]=o)}else{if(typeof l[t].push>"u"){const s=l[t];l[t]=[s]}const o=O(n);o!==""&&(Array.isArray(o["#text"])&&(o["#text"]=o["#text"][0]),l[t].push(o))}}return l}function g(e){const l=typeof Uint8Array<"u"?Uint8Array:Array,r=[],n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(let A=0,x=n.length;A<x;++A)r[n.charCodeAt(A)]=A;r[45]=62,r[95]=63;const t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");const o=e[t-2]==="="?2:e[t-1]==="="?1:0,s=new l(t*3/4-o),p=o>0?t-4:t;let u=0,c,h;for(c=0,h=0;c<p;c+=4,h+=3){const A=r[e.charCodeAt(c)]<<18|r[e.charCodeAt(c+1)]<<12|r[e.charCodeAt(c+2)]<<6|r[e.charCodeAt(c+3)];s[u++]=(A&16711680)>>16,s[u++]=(A&65280)>>8,s[u++]=A&255}if(o===2){const A=r[e.charCodeAt(c)]<<2|r[e.charCodeAt(c+1)]>>4;s[u++]=A&255}else if(o===1){const A=r[e.charCodeAt(c)]<<10|r[e.charCodeAt(c+1)]<<4|r[e.charCodeAt(c+2)]>>2;s[u++]=A>>8&255,s[u++]=A&255}return s}function I(e,l){let r=0;C.attributes.header_type==="UInt64"?r=8:C.attributes.header_type==="UInt32"&&(r=4);let n,t;if(e.attributes.format==="binary"&&l){e.attributes.type==="Float32"?n=new Float32Array:(e.attributes.type==="Int32"||e.attributes.type==="Int64")&&(n=new Int32Array);const o=e["#text"],s=Array.isArray(o)?o[0]:o,p=g(s),u=8;let c=p[0];for(let d=1;d<r-1;d++)c=c|p[d]<<d*u;let h=(c+3)*r;const A=h%3>0?3-h%3:0;h=h+A;const x=[];let m=h;x.push(m);const P=3*r;for(let d=0;d<c;d++){let S=p[d*r+P];for(let f=1;f<r-1;f++)S=S|p[d*r+P+f]<<f*u;m=m+S,x.push(m)}for(let d=0;d<x.length-1;d++)t=W(p.slice(x[d],x[d+1])).buffer,e.attributes.type==="Float32"?(t=new Float32Array(t),n=_(n,t)):(e.attributes.type==="Int32"||e.attributes.type==="Int64")&&(t=new Int32Array(t),n=U(n,t));delete e["#text"],e.attributes.type==="Int64"&&e.attributes.format==="binary"&&(n=n.filter(function(d,S){if(S%2!==1)return!0}))}else e.attributes.format==="binary"&&!l?(t=g(e["#text"]),t=t.slice(r).buffer):e["#text"]?t=e["#text"].split(/\s+/).filter(function(o){if(o!=="")return o}):t=new Int32Array(0).buffer,delete e["#text"],e.attributes.type==="Float32"?n=new Float32Array(t):e.attributes.type==="Int32"?n=new Int32Array(t):e.attributes.type==="Int64"&&(n=new Int32Array(t),e.attributes.format==="binary"&&(n=n.filter(function(o,s){if(s%2!==1)return!0})));return n}const D=new DOMParser().parseFromString(T,"application/xml").documentElement,C=O(D);let L=[],b=[],y=[];if(C.AppendedData){const e=C.AppendedData["#text"].slice(1),l=C.PolyData.Piece,r=["PointData","CellData","Points","Verts","Lines","Strips","Polys"];let n=0;const t=r.map(o=>{const s=l[o];return s&&s.DataArray?(Array.isArray(s.DataArray)?s.DataArray:[s.DataArray]).map(u=>u.attributes.offset):[]}).flat();for(const o of r){const s=l[o];if(s&&s.DataArray)if(Array.isArray(s.DataArray))for(const p of s.DataArray)p["#text"]=e.slice(t[n],t[n+1]),p.attributes.format="binary",n++;else s.DataArray["#text"]=e.slice(t[n],t[n+1]),s.DataArray.attributes.format="binary",n++}}if(C.PolyData){const e=C.PolyData.Piece,l=C.attributes.hasOwnProperty("compressor"),r=["PointData","Points","Strips","Polys"];let n=0;const t=r.length;for(;n<t;){const s=e[r[n]];if(s&&s.DataArray){let p;Array.isArray(s.DataArray)?p=s.DataArray:p=[s.DataArray];let u=0;const c=p.length;for(;u<c;)"#text"in p[u]&&p[u]["#text"].length>0&&(p[u].text=I(p[u],l)),u++;switch(r[n]){case"PointData":{const h=parseInt(e.attributes.NumberOfPoints),A=s.attributes.Normals;if(h>0){for(let x=0,m=p.length;x<m;x++)if(A===p[x].attributes.Name){const P=p[x].attributes.NumberOfComponents;b=new Float32Array(h*P),b.set(p[x].text,0)}}}break;case"Points":{const h=parseInt(e.attributes.NumberOfPoints);if(h>0){const A=s.DataArray.attributes.NumberOfComponents;L=new Float32Array(h*A),L.set(s.DataArray.text,0)}}break;case"Strips":{const h=parseInt(e.attributes.NumberOfStrips);if(h>0){const A=new Int32Array(s.DataArray[0].text.length),x=new Int32Array(s.DataArray[1].text.length);A.set(s.DataArray[0].text,0),x.set(s.DataArray[1].text,0);const m=h+A.length;y=new Uint32Array(3*m-9*h);let P=0;for(let d=0,S=h;d<S;d++){const f=[];for(let a=0,i=x[d],w=0;a<i-w;a++)f.push(A[a]),d>0&&(w=x[d-1]);for(let a=0,i=x[d],w=0;a<i-w-2;a++)a%2?(y[P++]=f[a],y[P++]=f[a+2],y[P++]=f[a+1]):(y[P++]=f[a],y[P++]=f[a+1],y[P++]=f[a+2]),d>0&&(w=x[d-1])}}}break;case"Polys":{const h=parseInt(e.attributes.NumberOfPolys);if(h>0){const A=new Int32Array(s.DataArray[0].text.length),x=new Int32Array(s.DataArray[1].text.length);A.set(s.DataArray[0].text,0),x.set(s.DataArray[1].text,0);const m=h+A.length;y=new Uint32Array(3*m-9*h);let P=0,d=0,S=0,f=0;const a=h;for(;S<a;){const i=[];let w=0;const F=x[S];for(;w<F-f;)i.push(A[d++]),w++;let R=1;for(;R<F-f-1;)y[P++]=i[0],y[P++]=i[R],y[P++]=i[R+1],R++;S++,f=x[S-1]}}}break}}n++}const o=new M;return o.setIndex(new k(y,1)),o.setAttribute("position",new k(L,3)),b.length===L.length&&o.setAttribute("normal",new k(b,3)),o}else throw new Error("Unsupported DATASET type")}const B=new TextDecoder,G=B.decode(new Uint8Array(E,0,250)).split(`
`);return G[0].indexOf("xml")!==-1?j(B.decode(E)):G[2].includes("ASCII")?V(B.decode(E)):Y(E)}}export{et as VTKLoader};
