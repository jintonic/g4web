import"./three-module-Bgl_dleh.js";import{EXRLoader as q}from"./EXRLoader-BhQuHtqe.js";import{a4 as W,a6 as I,M as G,y as V,o as C,a7 as X,ae as Y,al as H,an as D,aL as K,q as U,i as Q,B as Z,ab as ee,fu as te,a9 as se,aa as re,Y as ne,$ as ae,_ as oe,W as ie,r as ce,w as le,c as de,P as $,b as pe}from"./three-core-B2VhXfyC.js";import"./three-editor-CtR3j_K9.js";const E=new WeakMap;class we extends W{constructor(s){super(s),this.libraryPath="",this.libraryPending=null,this.libraryBinary=null,this.libraryConfig={},this.url="",this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.workerConfig={},this.materials=[],this.warnings=[]}setLibraryPath(s){return this.libraryPath=s,this}setWorkerLimit(s){return this.workerLimit=s,this}load(s,a,n,l){const t=new I(this.manager);t.setPath(this.path),t.setResponseType("arraybuffer"),t.setRequestHeader(this.requestHeader),this.url=s,t.load(s,d=>{if(E.has(d))return E.get(d).promise.then(a).catch(l);this.decodeObjects(d,s).then(c=>{c.userData.warnings=this.warnings,a(c)}).catch(c=>l(c))},n,l)}debug(){console.log("Task load: ",this.workerPool.map(s=>s._taskLoad))}decodeObjects(s,a){let n,l;const t=s.byteLength,d=this._getWorker(t).then(c=>(n=c,l=this.workerNextTaskID++,new Promise((u,S)=>{n._callbacks[l]={resolve:u,reject:S},n.postMessage({type:"decode",id:l,buffer:s},[s])}))).then(c=>this._createGeometry(c.data)).catch(c=>{throw c});return d.catch(()=>!0).then(()=>{n&&l&&this._releaseTask(n,l)}),E.set(s,{url:a,promise:d}),d}parse(s,a,n){this.decodeObjects(s,"").then(l=>{l.userData.warnings=this.warnings,a(l)}).catch(l=>n(l))}_compareMaterials(s){const a={};a.name=s.name,a.color={},a.color.r=s.color.r,a.color.g=s.color.g,a.color.b=s.color.b,a.type=s.type,a.vertexColors=s.vertexColors;const n=JSON.stringify(a);for(let l=0;l<this.materials.length;l++){const t=this.materials[l],d={};if(d.name=t.name,d.color={},d.color.r=t.color.r,d.color.g=t.color.g,d.color.b=t.color.b,d.type=t.type,d.vertexColors=t.vertexColors,JSON.stringify(d)===n)return t}return this.materials.push(s),s}_createMaterial(s,a){if(s===void 0)return new G({color:new C(1,1,1),metalness:.8,name:W.DEFAULT_MATERIAL_NAME,side:V});const n=new X({color:new C(s.diffuseColor.r/255,s.diffuseColor.g/255,s.diffuseColor.b/255),emissive:new C(s.emissionColor.r,s.emissionColor.g,s.emissionColor.b),flatShading:s.disableLighting,ior:s.indexOfRefraction,name:s.name,reflectivity:s.reflectivity,opacity:1-s.transparency,side:V,specularColor:s.specularColor,transparent:s.transparency>0});if(n.userData.id=s.id,s.pbrSupported){const t=s.pbr;n.anisotropy=t.anisotropic,n.anisotropyRotation=t.anisotropicRotation,n.color=new C(t.baseColor.r,t.baseColor.g,t.baseColor.b),n.clearcoat=t.clearcoat,n.clearcoatRoughness=t.clearcoatRoughness,n.metalness=t.metallic,n.transmission=1-t.opacity,n.roughness=t.roughness,n.sheen=t.sheen,n.specularIntensity=t.specular,n.thickness=t.subsurface}s.pbrSupported&&s.pbr.opacity===0&&s.transparency===1&&(n.opacity=.2,n.transmission=1);const l=new Y;for(let t=0;t<s.textures.length;t++){const d=s.textures[t];if(d.image!==null){const c=l.load(d.image);switch(d.type){case"Bump":n.bumpMap=c;break;case"Diffuse":n.map=c;break;case"Emap":n.envMap=c;break;case"Opacity":n.transmissionMap=c;break;case"Transparency":n.alphaMap=c,n.transparent=!0;break;case"PBR_Alpha":n.alphaMap=c,n.transparent=!0;break;case"PBR_AmbientOcclusion":n.aoMap=c;break;case"PBR_Anisotropic":n.anisotropyMap=c;break;case"PBR_BaseColor":n.map=c;break;case"PBR_Clearcoat":n.clearcoatMap=c;break;case"PBR_ClearcoatBump":n.clearcoatNormalMap=c;break;case"PBR_ClearcoatRoughness":n.clearcoatRoughnessMap=c;break;case"PBR_Displacement":n.displacementMap=c;break;case"PBR_Emission":n.emissiveMap=c;break;case"PBR_Metallic":n.metalnessMap=c;break;case"PBR_Roughness":n.roughnessMap=c;break;case"PBR_Sheen":n.sheenColorMap=c;break;case"PBR_Specular":n.specularColorMap=c;break;case"PBR_Subsurface":n.thicknessMap=c;break;default:this.warnings.push({message:`THREE.3DMLoader: No conversion exists for 3dm ${d.type}.`,type:"no conversion"});break}c.wrapS=d.wrapU===0?H:D,c.wrapT=d.wrapV===0?H:D,d.repeat&&c.repeat.set(d.repeat[0],d.repeat[1])}}return a&&new q().load(a.image,function(t){t.mapping=K,n.envMap=t}),n}_createGeometry(s){const a=new U,n=[],l=[],t=[];a.userData.layers=s.layers,a.userData.groups=s.groups,a.userData.settings=s.settings,a.userData.settings.renderSettings=s.renderSettings,a.userData.objectType="File3dm",a.userData.materials=null,a.name=this.url;let d=s.objects;const c=s.materials;for(let u=0;u<d.length;u++){const S=d[u],r=S.attributes;switch(S.objectType){case"InstanceDefinition":l.push(S);break;case"InstanceReference":t.push(S);break;default:let g=null;switch(r.materialSource.name){case"ObjectMaterialSource_MaterialFromLayer":r.layerIndex>=0&&(g=s.layers[r.layerIndex].renderMaterialIndex);break;case"ObjectMaterialSource_MaterialFromObject":r.materialIndex>=0&&(g=r.materialIndex);break}let o=null;if(g>=0){const p=c[g];o=this._createMaterial(p,s.renderEnvironment)}const e=this._createObject(S,o);if(e===void 0)continue;const h=s.layers[r.layerIndex];e.visible=h?s.layers[r.layerIndex].visible:!0,r.isInstanceDefinitionObject?n.push(e):a.add(e);break}}for(let u=0;u<l.length;u++){const S=l[u];d=[];for(let r=0;r<S.attributes.objectIds.length;r++){const g=S.attributes.objectIds[r];for(let o=0;o<n.length;o++){const e=n[o].userData.attributes.id;g===e&&d.push(n[o])}}for(let r=0;r<t.length;r++){const g=t[r];if(g.geometry.parentIdefId===S.attributes.id){const o=new U,e=g.geometry.xform.array,h=new Q;h.set(...e),o.applyMatrix4(h);for(let p=0;p<d.length;p++)o.add(d[p].clone(!0));a.add(o)}}}return a.userData.materials=this.materials,a.name="",a}_createObject(s,a){const n=new Z,l=s.attributes;let t,d,c,u;switch(s.objectType){case"Point":case"PointSet":t=n.parse(s.geometry),t.hasAttribute("color")?d=new $({vertexColors:!0,sizeAttenuation:!1,size:2}):(c=l.drawColor,u=new C(c.r/255,c.g/255,c.b/255),d=new $({color:u,sizeAttenuation:!1,size:2})),d=this._compareMaterials(d);const S=new pe(t,d);return S.userData.attributes=l,S.userData.objectType=s.objectType,l.name&&(S.name=l.name),S;case"Mesh":case"Extrusion":case"SubD":case"Brep":if(s.geometry===null)return;t=n.parse(s.geometry),a===null&&(a=this._createMaterial()),t.hasAttribute("color")&&(a.vertexColors=!0),a=this._compareMaterials(a);const r=new de(t,a);return r.castShadow=l.castsShadows,r.receiveShadow=l.receivesShadows,r.userData.attributes=l,r.userData.objectType=s.objectType,l.name&&(r.name=l.name),r;case"Curve":t=n.parse(s.geometry),c=l.drawColor,u=new C(c.r/255,c.g/255,c.b/255),d=new ce({color:u}),d=this._compareMaterials(d);const g=new le(t,d);return g.userData.attributes=l,g.userData.objectType=s.objectType,l.name&&(g.name=l.name),g;case"TextDot":t=s.geometry;const o=document.createElement("canvas").getContext("2d"),e=`${t.fontHeight}px ${t.fontFace}`;o.font=e;const h=o.measureText(t.text).width+10,p=t.fontHeight+10,b=window.devicePixelRatio;o.canvas.width=h*b,o.canvas.height=p*b,o.canvas.style.width=h+"px",o.canvas.style.height=p+"px",o.setTransform(b,0,0,b,0,0),o.font=e,o.textBaseline="middle",o.textAlign="center",u=l.drawColor,o.fillStyle=`rgba(${u.r},${u.g},${u.b},${u.a})`,o.fillRect(0,0,h,p),o.fillStyle="white",o.fillText(t.text,h/2,p/2);const f=new ne(o.canvas);f.minFilter=ae,f.generateMipmaps=!1,f.wrapS=D,f.wrapT=D,d=new oe({map:f,depthTest:!1});const m=new ie(d);return m.position.set(t.point[0],t.point[1],t.point[2]),m.scale.set(h/10,p/10,1),m.userData.attributes=l,m.userData.objectType=s.objectType,l.name&&(m.name=l.name),m;case"Light":t=s.geometry;let i;switch(t.lightStyle.name){case"LightStyle_WorldPoint":i=new re,i.castShadow=l.castsShadows,i.position.set(t.location[0],t.location[1],t.location[2]),i.shadow.normalBias=.1;break;case"LightStyle_WorldSpot":i=new se,i.castShadow=l.castsShadows,i.position.set(t.location[0],t.location[1],t.location[2]),i.target.position.set(t.direction[0],t.direction[1],t.direction[2]),i.angle=t.spotAngleRadians,i.shadow.normalBias=.1;break;case"LightStyle_WorldRectangular":i=new te;const T=Math.abs(t.width[2]),_=Math.abs(t.length[0]);i.position.set(t.location[0]-_/2,t.location[1],t.location[2]-T/2),i.height=_,i.width=T,i.lookAt(t.direction[0],t.direction[1],t.direction[2]);break;case"LightStyle_WorldDirectional":i=new ee,i.castShadow=l.castsShadows,i.position.set(t.location[0],t.location[1],t.location[2]),i.target.position.set(t.direction[0],t.direction[1],t.direction[2]),i.shadow.normalBias=.1;break}return i&&(i.intensity=t.intensity,c=t.diffuse,u=new C(c.r/255,c.g/255,c.b/255),i.color=u,i.userData.attributes=l,i.userData.objectType=s.objectType),i}}_initLibrary(){if(!this.libraryPending){const s=new I(this.manager);s.setPath(this.libraryPath);const a=new Promise((t,d)=>{s.load("rhino3dm.js",t,void 0,d)}),n=new I(this.manager);n.setPath(this.libraryPath),n.setResponseType("arraybuffer");const l=new Promise((t,d)=>{n.load("rhino3dm.wasm",t,void 0,d)});this.libraryPending=Promise.all([a,l]).then(([t,d])=>{this.libraryConfig.wasmBinary=d;const c=ue.toString(),u=["/* rhino3dm.js */",t,"/* worker */",c.substring(c.indexOf("{")+1,c.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([u]))})}return this.libraryPending}_getWorker(s){return this._initLibrary().then(()=>{if(this.workerPool.length<this.workerLimit){const n=new Worker(this.workerSourceURL);n._callbacks={},n._taskCosts={},n._taskLoad=0,n.postMessage({type:"init",libraryConfig:this.libraryConfig}),n.onmessage=l=>{const t=l.data;switch(t.type){case"warning":this.warnings.push(t.data),console.warn(t.data);break;case"decode":n._callbacks[t.id].resolve(t);break;case"error":n._callbacks[t.id].reject(t);break;default:console.error('THREE.Rhino3dmLoader: Unexpected message, "'+t.type+'"')}},this.workerPool.push(n)}else this.workerPool.sort(function(n,l){return n._taskLoad>l._taskLoad?-1:1});const a=this.workerPool[this.workerPool.length-1];return a._taskLoad+=s,a})}_releaseTask(s,a){s._taskLoad-=s._taskCosts[a],delete s._callbacks[a],delete s._taskCosts[a]}dispose(){for(let s=0;s<this.workerPool.length;++s)this.workerPool[s].terminate();this.workerPool.length=0}}function ue(){let v,s,a,n;onmessage=function(r){const g=r.data;switch(g.type){case"init":s=g.libraryConfig;const o=s.wasmBinary;let e;v=new Promise(function(p){e={wasmBinary:o,onRuntimeInitialized:p},rhino3dm(e)}).then(()=>{a=e});break;case"decode":n=g.id;const h=g.buffer;v.then(()=>{try{const p=l(a,h);self.postMessage({type:"decode",id:g.id,data:p})}catch(p){self.postMessage({type:"error",id:g.id,error:p})}});break}};function l(r,g){const o=new Uint8Array(g),e=r.File3dm.fromByteArray(o),h=[],p=[],b=[],f=[],m=[],i=[],T=[],_=e.objects(),M=_.count;for(let y=0;y<M;y++){const w=_.get(y),k=c(w,e);w.delete(),k&&h.push(k)}for(let y=0;y<e.instanceDefinitions().count;y++){const w=e.instanceDefinitions().get(y),k=u(w);k.objectIds=w.getObjectIds(),h.push({geometry:null,attributes:k,objectType:"InstanceDefinition"})}const R=[r.TextureType.Diffuse,r.TextureType.Bump,r.TextureType.Transparency,r.TextureType.Opacity,r.TextureType.Emap],P=[r.TextureType.PBR_BaseColor,r.TextureType.PBR_Subsurface,r.TextureType.PBR_SubsurfaceScattering,r.TextureType.PBR_SubsurfaceScatteringRadius,r.TextureType.PBR_Metallic,r.TextureType.PBR_Specular,r.TextureType.PBR_SpecularTint,r.TextureType.PBR_Roughness,r.TextureType.PBR_Anisotropic,r.TextureType.PBR_Anisotropic_Rotation,r.TextureType.PBR_Sheen,r.TextureType.PBR_SheenTint,r.TextureType.PBR_Clearcoat,r.TextureType.PBR_ClearcoatBump,r.TextureType.PBR_ClearcoatRoughness,r.TextureType.PBR_OpacityIor,r.TextureType.PBR_OpacityRoughness,r.TextureType.PBR_Emission,r.TextureType.PBR_AmbientOcclusion,r.TextureType.PBR_Displacement];for(let y=0;y<e.materials().count;y++){const w=e.materials().get(y),k=u(w),j=[];j.push(...t(w,R,e)),k.pbrSupported=w.physicallyBased().supported,k.pbrSupported&&(j.push(...t(w,P,e)),k.pbr=u(w.physicallyBased())),k.textures=j,p.push(k),w.delete()}for(let y=0;y<e.layers().count;y++){const w=e.layers().get(y),k=u(w);b.push(k),w.delete()}for(let y=0;y<e.views().count;y++){const w=e.views().get(y),k=u(w);f.push(k),w.delete()}for(let y=0;y<e.namedViews().count;y++){const w=e.namedViews().get(y),k=u(w);m.push(k),w.delete()}for(let y=0;y<e.groups().count;y++){const w=e.groups().get(y),k=u(w);i.push(k),w.delete()}const x=u(e.settings()),L=e.strings().count;for(let y=0;y<L;y++)T.push(e.strings().get(y));const B=e.settings().renderSettings().renderEnvironments.reflectionId,F=e.renderContent();let N=null;for(let y=0;y<F.count;y++){const w=F.get(y);switch(w.kind){case"environment":if(w.id!==B)break;const O=w.findChild("texture").fileName;for(let A=0;A<e.embeddedFiles().count;A++){const J=e.embeddedFiles().get(A).fileName;O===J&&(N={type:"renderEnvironment",image:"data:image/png;base64,"+e.getEmbeddedFileAsBase64(O),name:O})}break}}const z={ambientLight:e.settings().renderSettings().ambientLight,backgroundColorTop:e.settings().renderSettings().backgroundColorTop,backgroundColorBottom:e.settings().renderSettings().backgroundColorBottom,useHiddenLights:e.settings().renderSettings().useHiddenLights,depthCue:e.settings().renderSettings().depthCue,flatShade:e.settings().renderSettings().flatShade,renderBackFaces:e.settings().renderSettings().renderBackFaces,renderPoints:e.settings().renderSettings().renderPoints,renderCurves:e.settings().renderSettings().renderCurves,renderIsoParams:e.settings().renderSettings().renderIsoParams,renderMeshEdges:e.settings().renderSettings().renderMeshEdges,renderAnnotations:e.settings().renderSettings().renderAnnotations,useViewportSize:e.settings().renderSettings().useViewportSize,scaleBackgroundToFit:e.settings().renderSettings().scaleBackgroundToFit,transparentBackground:e.settings().renderSettings().transparentBackground,imageDpi:e.settings().renderSettings().imageDpi,shadowMapLevel:e.settings().renderSettings().shadowMapLevel,namedView:e.settings().renderSettings().namedView,snapShot:e.settings().renderSettings().snapShot,specificViewport:e.settings().renderSettings().specificViewport,groundPlane:u(e.settings().renderSettings().groundPlane),safeFrame:u(e.settings().renderSettings().safeFrame),dithering:u(e.settings().renderSettings().dithering),skylight:u(e.settings().renderSettings().skylight),linearWorkflow:u(e.settings().renderSettings().linearWorkflow),renderChannels:u(e.settings().renderSettings().renderChannels),sun:u(e.settings().renderSettings().sun),renderEnvironments:u(e.settings().renderSettings().renderEnvironments),postEffects:u(e.settings().renderSettings().postEffects)};return e.delete(),{objects:h,materials:p,layers:b,views:f,namedViews:m,groups:i,strings:T,settings:x,renderSettings:z,renderEnvironment:N}}function t(r,g,o){const e=[];for(let h=0;h<g.length;h++){const p=r.getTexture(g[h]);if(p){let b=g[h].constructor.name;b=b.substring(12,b.length);const f=d(p,b,o);e.push(f),p.delete()}}return e}function d(r,g,o){const e={type:g},h=o.getEmbeddedFileAsBase64(r.fileName);e.wrapU=r.wrapU,e.wrapV=r.wrapV,e.wrapW=r.wrapW;const p=r.uvwTransform.toFloatArray(!0);return e.repeat=[p[0],p[5]],h?e.image="data:image/png;base64,"+h:(self.postMessage({type:"warning",id:n,data:{message:`THREE.3DMLoader: Image for ${g} texture not embedded in file.`,type:"missing resource"}}),e.image=null),e}function c(r,g){const o=r.geometry(),e=r.attributes();let h=o.objectType,p,b,f,m,i;switch(h){case a.ObjectType.Curve:const T=S(o,100);f={},b={},m={},f.itemSize=3,f.type="Float32Array",f.array=[];for(let x=0;x<T.length;x++)f.array.push(T[x][0]),f.array.push(T[x][1]),f.array.push(T[x][2]);b.position=f,m.attributes=b,p={data:m};break;case a.ObjectType.Point:const _=o.location;f={};const M={};b={},m={},f.itemSize=3,f.type="Float32Array",f.array=[_[0],_[1],_[2]];const R=e.drawColor(g);M.itemSize=3,M.type="Float32Array",M.array=[R.r/255,R.g/255,R.b/255],b.position=f,b.color=M,m.attributes=b,p={data:m};break;case a.ObjectType.PointSet:case a.ObjectType.Mesh:p=o.toThreejsJSON();break;case a.ObjectType.Brep:const P=o.faces();i=new a.Mesh;for(let x=0;x<P.count;x++){const L=P.get(x),B=L.getMesh(a.MeshType.Any);B&&(i.append(B),B.delete()),L.delete()}i.faces().count>0&&(i.compact(),p=i.toThreejsJSON(),P.delete()),i.delete();break;case a.ObjectType.Extrusion:i=o.getMesh(a.MeshType.Any),i&&(p=i.toThreejsJSON(),i.delete());break;case a.ObjectType.TextDot:p=u(o);break;case a.ObjectType.Light:p=u(o),p.lightStyle.name==="LightStyle_WorldLinear"&&self.postMessage({type:"warning",id:n,data:{message:`THREE.3DMLoader: No conversion exists for ${h.constructor.name} ${p.lightStyle.name}`,type:"no conversion",guid:e.id}});break;case a.ObjectType.InstanceReference:p=u(o),p.xform=u(o.xform),p.xform.array=o.xform.toFloatArray(!0);break;case a.ObjectType.SubD:o.subdivide(3),i=a.Mesh.createFromSubDControlNet(o,!1),i&&(p=i.toThreejsJSON(),i.delete());break;default:self.postMessage({type:"warning",id:n,data:{message:`THREE.3DMLoader: Conversion not implemented for ${h.constructor.name}`,type:"not implemented",guid:e.id}});break}if(p)return b=u(e),b.geometry=u(o),e.groupCount>0&&(b.groupIds=e.getGroupList()),e.userStringCount>0&&(b.userStrings=e.getUserStrings()),o.userStringCount>0&&(b.geometry.userStrings=o.getUserStrings()),e.decals().count>0&&self.postMessage({type:"warning",id:n,data:{message:"THREE.3DMLoader: No conversion exists for the decals associated with this object.",type:"no conversion",guid:e.id}}),b.drawColor=e.drawColor(g),h=h.constructor.name,h=h.substring(11,h.length),{geometry:p,attributes:b,objectType:h};self.postMessage({type:"warning",id:n,data:{message:`THREE.3DMLoader: ${h.constructor.name} has no associated mesh geometry.`,type:"missing mesh",guid:e.id}})}function u(r){const g={};for(const o in r){const e=r[o];typeof e!="function"&&(typeof e=="object"&&e!==null&&e.hasOwnProperty("constructor")?g[o]={name:e.constructor.name,value:e.value}:typeof e=="object"&&e!==null?g[o]=u(e):g[o]=e)}return g}function S(r,g){let o=g,e=[];const h=[];if(r instanceof a.LineCurve)return[r.pointAtStart,r.pointAtEnd];if(r instanceof a.PolylineCurve){o=r.pointCount;for(let f=0;f<o;f++)e.push(r.point(f));return e}if(r instanceof a.PolyCurve){const f=r.segmentCount;for(let m=0;m<f;m++){const i=r.segmentCurve(m),T=S(i,o);e=e.concat(T),i.delete()}return e}if(r instanceof a.ArcCurve&&(o=Math.floor(r.angleDegrees/5),o=o<2?2:o),r instanceof a.NurbsCurve&&r.degree===1){const f=r.tryGetPolyline();for(let m=0;m<f.count;m++)e.push(f.get(m));return f.delete(),e}const p=r.domain,b=o-1;for(let f=0;f<o;f++){const m=p[0]+f/b*(p[1]-p[0]);if(m===p[0]||m===p[1]){h.push(m);continue}const i=r.tangentAt(m),T=r.tangentAt(h.slice(-1)[0]),_=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],M=T[0]*T[0]+T[1]*T[1]+T[2]*T[2],R=Math.sqrt(_*M);let P;if(R===0)P=Math.PI/2;else{const x=(i.x*T.x+i.y*T.y+i.z*T.z)/R;P=Math.acos(Math.max(-1,Math.min(1,x)))}P<.1||h.push(m)}return e=h.map(f=>r.pointAt(f)),e}}export{we as Rhino3dmLoader};
