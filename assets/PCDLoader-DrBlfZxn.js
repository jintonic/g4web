import"./three-module-BI8WDeO_.js";import{a4 as A,a6 as S,o as U,Z as V,u as C,F as O,eJ as L,P,b as T}from"./three-core-BBimCphi.js";class G extends A{constructor(d){super(d),this.littleEndian=!0}load(d,g,z,e){const p=this,c=new S(p.manager);c.setPath(p.path),c.setResponseType("arraybuffer"),c.setRequestHeader(p.requestHeader),c.setWithCredentials(p.withCredentials),c.load(d,function(y){try{g(p.parse(y))}catch(m){e?e(m):console.error(m),p.manager.itemError(d)}},z,e)}_getDataView(d,g,z,e){switch(z){case"F":return e===8?d.getFloat64(g,this.littleEndian):d.getFloat32(g,this.littleEndian);case"I":return e===1?d.getInt8(g):e===2?d.getInt16(g,this.littleEndian):d.getInt32(g,this.littleEndian);case"U":return e===1?d.getUint8(g):e===2?d.getUint16(g,this.littleEndian):d.getUint32(g,this.littleEndian)}}parse(d){function g(s,t){const h=s.length,l=new Uint8Array(t);let i=0,r=0,n,o,f;do if(n=s[i++],n<32){if(n++,r+n>t)throw new Error("Output buffer is not large enough");if(i+n>h)throw new Error("Invalid compressed data");do l[r++]=s[i++];while(--n)}else{if(o=n>>5,f=r-((n&31)<<8)-1,i>=h)throw new Error("Invalid compressed data");if(o===7&&(o+=s[i++],i>=h))throw new Error("Invalid compressed data");if(f-=s[i++],r+o+2>t)throw new Error("Output buffer is not large enough");if(f<0)throw new Error("Invalid compressed data");if(f>=r)throw new Error("Invalid compressed data");do l[r++]=l[f++];while(--o+2)}while(i<h);return l}function z(s){const t={},h=new Uint8Array(s);let l="",i="",r=0,n=!1;const o=h.length;for(;r<o&&n===!1;){const a=String.fromCharCode(h[r++]);a===`
`||a==="\r"?(i.trim().toLowerCase().startsWith("data")&&(n=!0),i=""):i+=a,l+=a}const f=l.search(/[\r\n]DATA\s(\S*)\s/i),u=/[\r\n]DATA\s(\S*)\s/i.exec(l.slice(f-1));if(t.data=u[1],t.headerLen=u[0].length+f,t.str=l.slice(0,t.headerLen),t.str=t.str.replace(/#.*/gi,""),t.version=/^VERSION (.*)/im.exec(t.str),t.fields=/^FIELDS (.*)/im.exec(t.str),t.size=/^SIZE (.*)/im.exec(t.str),t.type=/^TYPE (.*)/im.exec(t.str),t.count=/^COUNT (.*)/im.exec(t.str),t.width=/^WIDTH (.*)/im.exec(t.str),t.height=/^HEIGHT (.*)/im.exec(t.str),t.viewpoint=/^VIEWPOINT (.*)/im.exec(t.str),t.points=/^POINTS (.*)/im.exec(t.str),t.version!==null&&(t.version=parseFloat(t.version[1])),t.fields=t.fields!==null?t.fields[1].split(" "):[],t.type!==null&&(t.type=t.type[1].split(" ")),t.width!==null&&(t.width=parseInt(t.width[1])),t.height!==null&&(t.height=parseInt(t.height[1])),t.viewpoint!==null&&(t.viewpoint=t.viewpoint[1]),t.points!==null&&(t.points=parseInt(t.points[1],10)),t.points===null&&(t.points=t.width*t.height),t.size!==null&&(t.size=t.size[1].split(" ").map(function(a){return parseInt(a,10)})),t.count!==null)t.count=t.count[1].split(" ").map(function(a){return parseInt(a,10)});else{t.count=[];for(let a=0,_=t.fields.length;a<_;a++)t.count.push(1)}t.offset={};let w=0;for(let a=0,_=t.fields.length;a<_;a++)t.data==="ascii"?t.offset[t.fields[a]]=a:(t.offset[t.fields[a]]=w,w+=t.size[a]*t.count[a]);return t.rowSize=w,t}const e=z(d),p=[],c=[],y=[],m=[],I=[],x=new U;if(e.data==="ascii"){const s=e.offset,l=new TextDecoder().decode(d).slice(e.headerLen).split(`
`);for(let i=0,r=l.length;i<r;i++){if(l[i]==="")continue;const n=l[i].split(" ");if(s.x!==void 0&&(p.push(parseFloat(n[s.x])),p.push(parseFloat(n[s.y])),p.push(parseFloat(n[s.z]))),s.rgb!==void 0){const o=e.fields.findIndex(D=>D==="rgb"),f=e.type[o],u=parseFloat(n[s.rgb]);let w=u;if(f==="F"){const D=new Float32Array(1);D[0]=u,w=new Int32Array(D.buffer)[0]}const a=(w>>16&255)/255,_=(w>>8&255)/255,F=(w>>0&255)/255;x.setRGB(a,_,F,V),y.push(x.r,x.g,x.b)}s.normal_x!==void 0&&(c.push(parseFloat(n[s.normal_x])),c.push(parseFloat(n[s.normal_y])),c.push(parseFloat(n[s.normal_z]))),s.intensity!==void 0&&m.push(parseFloat(n[s.intensity])),s.label!==void 0&&I.push(parseInt(n[s.label]))}}if(e.data==="binary_compressed"){const s=new Uint32Array(d.slice(e.headerLen,e.headerLen+8)),t=s[0],h=s[1],l=g(new Uint8Array(d,e.headerLen+8,t),h),i=new DataView(l.buffer),r=e.offset;for(let n=0;n<e.points;n++){if(r.x!==void 0){const o=e.fields.indexOf("x"),f=e.fields.indexOf("y"),u=e.fields.indexOf("z");p.push(this._getDataView(i,e.points*r.x+e.size[o]*n,e.type[o],e.size[o])),p.push(this._getDataView(i,e.points*r.y+e.size[f]*n,e.type[f],e.size[f])),p.push(this._getDataView(i,e.points*r.z+e.size[u]*n,e.type[u],e.size[u]))}if(r.rgb!==void 0){const o=e.fields.indexOf("rgb"),f=i.getUint8(e.points*r.rgb+e.size[o]*n+2)/255,u=i.getUint8(e.points*r.rgb+e.size[o]*n+1)/255,w=i.getUint8(e.points*r.rgb+e.size[o]*n+0)/255;x.setRGB(f,u,w,V),y.push(x.r,x.g,x.b)}if(r.normal_x!==void 0){const o=e.fields.indexOf("normal_x"),f=e.fields.indexOf("normal_y"),u=e.fields.indexOf("normal_z");c.push(this._getDataView(i,e.points*r.normal_x+e.size[o]*n,e.type[o],e.size[o])),c.push(this._getDataView(i,e.points*r.normal_y+e.size[f]*n,e.type[f],e.size[f])),c.push(this._getDataView(i,e.points*r.normal_z+e.size[u]*n,e.type[u],e.size[u]))}if(r.intensity!==void 0){const o=e.fields.indexOf("intensity");m.push(this._getDataView(i,e.points*r.intensity+e.size[o]*n,e.type[o],e.size[o]))}if(r.label!==void 0){const o=e.fields.indexOf("label");I.push(this._getDataView(i,e.points*r.label+e.size[o]*n,e.type[o],e.size[o]))}}}if(e.data==="binary"){const s=new DataView(d,e.headerLen),t=e.offset;for(let h=0,l=0;h<e.points;h++,l+=e.rowSize){if(t.x!==void 0){const i=e.fields.indexOf("x"),r=e.fields.indexOf("y"),n=e.fields.indexOf("z");p.push(this._getDataView(s,l+t.x,e.type[i],e.size[i])),p.push(this._getDataView(s,l+t.y,e.type[r],e.size[r])),p.push(this._getDataView(s,l+t.z,e.type[n],e.size[n]))}if(t.rgb!==void 0){const i=s.getUint8(l+t.rgb+2)/255,r=s.getUint8(l+t.rgb+1)/255,n=s.getUint8(l+t.rgb+0)/255;x.setRGB(i,r,n,V),y.push(x.r,x.g,x.b)}if(t.normal_x!==void 0){const i=e.fields.indexOf("normal_x"),r=e.fields.indexOf("normal_y"),n=e.fields.indexOf("normal_z");c.push(this._getDataView(s,l+t.normal_x,e.type[i],e.size[i])),c.push(this._getDataView(s,l+t.normal_y,e.type[r],e.size[r])),c.push(this._getDataView(s,l+t.normal_z,e.type[n],e.size[n]))}if(t.intensity!==void 0){const i=e.fields.indexOf("intensity");m.push(this._getDataView(s,l+t.intensity,e.type[i],e.size[i]))}if(t.label!==void 0){const i=e.fields.indexOf("label");I.push(this._getDataView(s,l+t.label,e.type[i],e.size[i]))}}}const b=new C;p.length>0&&b.setAttribute("position",new O(p,3)),c.length>0&&b.setAttribute("normal",new O(c,3)),y.length>0&&b.setAttribute("color",new O(y,3)),m.length>0&&b.setAttribute("intensity",new O(m,1)),I.length>0&&b.setAttribute("label",new L(I,1)),b.computeBoundingSphere();const E=new P({size:.005});return y.length>0&&(E.vertexColors=!0),new T(b,E)}}export{G as PCDLoader};
